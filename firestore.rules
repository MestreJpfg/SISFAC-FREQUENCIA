/**
 * @fileoverview Firestore Security Rules for the school attendance tracker app.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure access to student and attendance data. It allows public read access to student and attendance information,
 * but restricts write access to prevent unauthorized modifications.
 *
 * Data Structure:
 * - `/students/{studentId}`: Stores student information.
 * - `/attendance/{attendanceId}`: Stores attendance records.
 *
 * Key Security Decisions:
 * - Students and attendance records are publicly readable to facilitate data display.
 * - Only authenticated users can create, update, or delete student/attendance records.
 *   While the app is using anonymous auth for prototyping, these rules still require authentication for write operations.
 *
 * Denormalization for Authorization: N/A (currently not needed, but consider adding owner/author fields if write restrictions need refinement).
 * Structural Segregation: N/A (all collections are top-level in this prototype).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read student data, but requires authentication to create, update, or delete student records.
     * @path /databases/{database}/documents/students/{studentId}
     * @allow (get, list): Any user can read student data.
     * @allow (create): Authenticated user can create a student.
     * @allow (update, delete): Authenticated user can update and delete a student.
     * @deny (create, update, delete): Unauthenticated user cannot create, update or delete.
     * @principle Allows public read access with authenticated-user-only writes for students.
     */
    match /students/{studentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read attendance records, but requires authentication to create, update, or delete records.
     * @path /databases/{database}/documents/attendance/{attendanceId}
     * @allow (get, list): Any user can read attendance records.
     * @allow (create): Authenticated user can create an attendance record.
     * @allow (update, delete): Authenticated user can update and delete an attendance record.
     * @deny (create, update, delete): Unauthenticated user cannot create, update, or delete.
     * @principle Allows public read access with authenticated-user-only writes for attendance records.
     */
    match /attendance/{attendanceId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    // Helper function to check if a user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }
  }
}
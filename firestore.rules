/**
 * @fileoverview Firestore Security Rules for the school attendance tracker.
 *
 * Core Philosophy:
 * This ruleset implements role-based access control (RBAC) to protect data.
 * All operations require an authenticated user whose profile is marked as active
 * in the 'users' collection. Specific roles (admin, superUser, user) dictate
 * permissions on the 'students' and 'attendance' collections. A user can always
 * read their own profile.
 *
 * Data Structure:
 * - /students/{studentId}: Stores individual student data.
 * - /attendance/{attendanceId}: Stores individual attendance records.
 * - /users/{userId}: Stores user profiles with role and status.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the requesting user is authenticated and has an active profile
     *              in the 'users' collection. This is the base-level requirement for most
     *              data access in the application.
     * @returns {Boolean} True if the user is signed in and their profile exists and is active.
     */
    function isSignedInAndActive() {
      let userId = request.auth.uid;
      return userId != null && get(/databases/$(database)/documents/users/$(userId)).data.isActive == true;
    }

    /**
     * @description Checks if the user's role is 'admin'.
     * @returns {Boolean} True if the user is an admin.
     */
    function isAdmin() {
      let userId = request.auth.uid;
      return get(/databases/$(database)/documents/users/$(userId)).data.role == 'admin';
    }

     /**
     * @description Checks if the user's role is 'superUser'.
     * @returns {Boolean} True if the user is a superUser.
     */
    function isSuperUser() {
      let userId = request.auth.uid;
      return get(/databases/$(database)/documents/users/$(userId)).data.role == 'superUser';
    }

    /**
     * @path /users/{userId}
     * @description Rules for the user profiles collection.
     * - Read: Any authenticated user can read user profiles. This is necessary for the app to
     *         check a user's own role and active status upon login.
     * - Write: Only admins can create, update, or delete user profiles.
     */
    match /users/{userId} {
      allow read: if request.auth.uid != null;
      allow write: if isAdmin();
    }
    
    /**
     * @path /students/{studentId}
     * @description Rules for the students collection.
     * - Read: Any active user can read student data.
     * - Write: Only admins can create, update, or delete student records.
     */
    match /students/{studentId} {
      allow read: if isSignedInAndActive();
      allow write: if isSignedInAndActive() && isAdmin();
    }

    /**
     * @path /attendance/{attendanceId}
     * @description Rules for the attendance collection.
     * - Read: Any active user can read attendance data.
     * - Write: Admins and Super Users can create, update, or delete attendance records.
     */
    match /attendance/{attendanceId} {
      allow read: if isSignedInAndActive();
      allow write: if isSignedInAndActive() && (isAdmin() || isSuperUser());
    }
  }
}

/**
 * @description This ruleset enforces a strict read/write access control model based on document-level ownership.
 * Only authenticated users can access the data.
 * @dataStructure
 * - /students/{studentId}: Stores student profiles.
 * - /attendance/{attendanceId}: Stores individual attendance records.
 * @keySecurityDecisions
 * - Anonymous authentication is used, so `request.auth` will be non-null for all logged-in users.
 * - All read and write operations require authentication.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to student profiles.
     * @path /students/{studentId}
     * @allow (create) - Authenticated user can create a student profile.
     * @allow (get, list, update, delete) - Only the owner can read, update, and delete their student profile.
     * @deny (create) - Request without authentication.
     * @deny (get, list, update, delete) - Request without authentication.
     * @deny (update) - Attempt to modify the studentId.
     * @principle Enforces document ownership for writes.
     */
    match /students/{studentId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to attendance records.
     * @path /attendance/{attendanceId}
     * @allow (create) - Authenticated user can create an attendance record.
     * @allow (get, list, update, delete) - Only the owner can read, update, and delete their attendance record.
     * @deny (create) - Request without authentication.
     * @deny (get, list, update, delete) - Request without authentication.
     * @principle Enforces document ownership for writes.
     */
    match /attendance/{attendanceId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    function isSignedIn() {
      return request.auth != null;
    }
  }
}
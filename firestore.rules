/**
 * @file Firestore Security Rules
 * @description This ruleset allows only authenticated users to manage students and attendance records.
 *
 * Core Philosophy:
 *   This ruleset focuses on securing access to student and attendance data by requiring authentication.
 *   All operations require a signed-in user.
 *   The rules are designed to be permissive on data shapes during this prototyping phase, focusing on authorization.
 *
 * Data Structure:
 *   - /students/{studentId}: Stores individual student data.
 *   - /attendance/{attendanceId}: Stores individual attendance records.
 *
 * Key Security Decisions:
 *   - Anonymous authentication is enabled, so any signed-in user can create/modify/delete any student or attendance record.
 *   - No specific ownership or roles are enforced in this initial version.
 *
 * Denormalization for Authorization:
 *   No denormalization is needed at this stage, as authentication is the primary requirement.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to the 'students' collection.
     * @path /students/{studentId}
     * @allow (create) Authenticated user can create student.
     * @deny  (create) Unauthenticated user cannot create student.
     * @allow (get, list) Authenticated user can read student data.
     * @deny (get, list) Unauthenticated user cannot read student data.
     * @allow (update) Authenticated user can update student data.
     * @deny (update) Unauthenticated user cannot update student data.
     * @allow (delete) Authenticated user can delete student data.
     * @deny (delete) Unauthenticated user cannot delete student data.
     * @principle Requires authentication for all operations.
     */
    match /students/{studentId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Controls access to the 'attendance' collection.
     * @path /attendance/{attendanceId}
     * @allow (create) Authenticated user can create attendance record.
     * @deny  (create) Unauthenticated user cannot create attendance record.
     * @allow (get, list) Authenticated user can read attendance data.
     * @deny (get, list) Unauthenticated user cannot read attendance data.
     * @allow (update) Authenticated user can update attendance data.
     * @deny (update) Unauthenticated user cannot update attendance data.
     * @allow (delete) Authenticated user can delete attendance data.
     * @deny (delete) Unauthenticated user cannot delete attendance data.
     * @principle Requires authentication for all operations.
     */
    match /attendance/{attendanceId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }
  }

  // Helper function to determine if a user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }
}